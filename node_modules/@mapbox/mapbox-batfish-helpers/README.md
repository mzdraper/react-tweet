# mapbox-batfish-helpers

[![Build Status](https://travis-ci.com/mapbox/mapbox-batfish-helpers.svg?token=FB2dZNVWaGo68KZnwz9M&branch=master)](https://travis-ci.com/mapbox/mapbox-batfish-helpers)

Documentation and helpers for setting up a conventional Mapbox Batfish website.

**Import individual files.**
There is no `index.js` that includes everything, because some files are for client-side JS, some for Node.

## Table of contents

- [Publishing Batfish sites at Mapbox](#publishing-batfish-sites-at-mapbox)
  - [Build locally first](#build-locally-first)
  - [Working with Publisher](#working-with-publisher)
  - [Enabling deep links for client-side routing](#enabling-deep-links-for-client-side-routing)
- [modifyConfig](#modifyconfig)
  - [modifyConfig.addMapboxAssemblyCss](#modifyconfigaddmapboxassemblycss)
  - [modifyConfig.addDeployEnv](#modifyconfigadddeployenv)
  - [modifyConfig.addSvgReactTransformer](#modifyconfigaddsvgreacttransformer)
  - [modifyConfig.addSiteOrigin](#modifyconfigaddsiteorigin)
- [For the browser](#for-the-browser)
  - [browser-eslint-config.json](#browser-eslint-configjson)
  - [createEnvConfig](#createenvconfig)
  - [pageShellInit](#pageshellinit)
  - [loadMapboxAssemblyJs](#loadmapboxassemblyjs)

## Publishing Batfish sites at Mapbox

### Build locally first

**Build locally before sending your site to Publisher.**
Build failures will show up faster and be easier to debug if you do this.

You'll need to execute `batfish build`, which you've probably aliased to `npm run build`.

### Working with Publisher

To publish your site with [Publisher](https://github.com/mapbox/publisher/), you'll need to create a `_config.yml` file like this:

```yml
source: _batfish_site
```

Publisher always runs Jekyll and copies *Jekyll's output in `_site`* to S3.
This configuration file tells Jekyll to do nothing more than copy Batfish's output to `_site`.
Then Publisher will copy `_site` to S3.

### Enabling deep links for client-side routing

If you are using a client-side router like [React Router](https://reacttraining.com/react-router/)), instead of Batfish's router, and you want to allow people to visit deep links (go directly to a nested URL, instead of landing on the home page and navigating there), you may want to use *hash-based routing* instead of *the HTML5 history API* (e.g. React Router's [`HashRouter`](https://reacttraining.com/react-router/web/api/HashRouter)).
Your routes will end up looking like `/my-site/#/my-page` instead of `/my-site/my-page`.
The reason to route with hashes is to avoid having to change the server configuration at all.

If you *do* need nice-looking URLs, without hashes, you'll need to add redirects to the configuration of Fastly (our static sites' CDN).
Please check out [the fastly-config repo](https://github.com/mapbox/fastly-config) to learn more about this.

## modifyConfig

```js
const modifyConfig = require('@mapbox/mapbox-batfish-helpers/modify-config');
```

Helper functions that amend your Batfish config in conventional ways.

Typically, your `batfish.config.js` file will end up looking like this:

```js
'use strict';

const modifyConfig = require('@mapbox/mapbox-batfish-helpers/modify-config');

module.exports = () => {
  let config = {
    // Your config ...
  };
  
  config = modifyConfig.addMapboxAssemblyCss(config);
  // Other modifyConfig functions ...
  
  return config;
};
```

### modifyConfig.addMapboxAssemblyCss

**To use this helper, you must have installed @mapbox/mbx-assembly.**

```js
modifyConfig.addMapboxAssembly(batfishConfig);
```

Takes your Batfish config and returns a new one, adjusted so that:

- mbx-assembly is added to your `stylesheets`.
- If you create site-specific styles, they will run through all the PostCSS plugins that mbx-assembly uses, giving you autoprefixing, color variables, media query variables, etc.

**You should also load mbx-assembly's JS into your page with the client-side [`loadMapboxAssemblyJs`] helper.**

### modifyConfig.addDeployEnv

```js
modifyConfig.addDeployEnv(batfishConfig);
```

Takes your Batfish config and returns a new one, adjusted so that:

- `process.env.DEPLOY_ENV` is available within client-side JS files.
  It is set to `production` if you are on an `mb-pages` or `hey-pages` branch, or if you manually set the environment variable (e.g. `DEPLOY_ENV=production batfish start`).
  Otherwise, it is set to `staging`.

You can then use `process.env.DEPLOY_ENV` in your code to do different things based on the environment.
**Typically this should be used in tandem with the client-side [`createEnvConfig`] helper.**

### modifyConfig.addSvgReactTransformer

**To use this helper, you must have installed @mapbox/svg-react-transformer.**

```js
modifyConfig.addMapboxAssembly(batfishConfig, [template]);
```

The `template` argument defaults to `'fancy'`.

Takes your Batfish config and returns a new one, adjusted so that:

- You can `import` an SVG file and get a React component that renders an optimized version of the SVG inline, tailored for accessibility and fluid dimensions.

Please read the [svg-react-transformer docs](https://github.com/mapbox/svg-react-transformer/tree/master/packages/svg-react-transformer) for more information.

### modifyConfig.addSiteOrigin

```js
modifyConfig.addSiteOrigin(batfishConfig);
```

Takes your Batfish config and returns a new one, adjusted so that:

- `siteOrigin` is set to the standard Mapbox production, staging, or hey origin.
  The function looks at your Git branch and `process.env.DEPLOY_ENV` to determine the suitable origin.
  - If the branch is `hey-pages`, you'll get the hey origin.
  - If you're on `mb-pages`, or `DEPLOY_ENV=production` and you're *not* on `hey-pages`, you'll get the production origin.
  - Otherwise, you'll get the staging origin.

**You also want to set `siteBasePath`, but should do this manually.**
In most cases, it's as easy as specifying your repo name, e.g. `'account'` or `'studio'`.

## For the browser

### `browser-eslint-config.json`

There are a few steps required to get ESLint working nicely with JSX and ES2015 modules.
`browser-eslint-config.json` exemplifies the minimum.

**To use the config, you must have installed [eslint-plugin-react](https://github.com/yannickcr/eslint-plugin-react), [eslint-plugin-import](https://github.com/benmosher/eslint-plugin-import/issues), and [babel-eslint](https://github.com/babel/babel-eslint).**

You could copy-paste this code, or import/extend it and modify it at will.

### createEnvConfig

```js
import createEnvConfig from '@mapbox/mapbox-batfish-helpers/browser/create-env-config';
```

**This helper should be used in tandem with [`modifyConfig.addDeployEnv`]**, because it relies on a `process.env.DEPLOY_ENV` variable exposed to client-side JS.

```js
createEnvConfig(entries)
```

Create a config object whose values differ depending on whether the build is for staging or production (as determined by `process.env.DEPLOY_ENV`).

By default, the config object includes an `API_URL_ORIGIN` variable.
To add your own, provide an argument object whose keys are variable names and values are objects with `staging` and `production` properties.
For example,

```js
// src/config.js
import createEnvConfig from '@mapbox/mapbox-batfish-helpers/browser/create-env-config';

export default createEnvConfig({
  ACCESS_TOKEN: {
    staging: 'pk.eyJ1...',
    production: 'pk.su33...'
  }
});

// Now, in staging config will look like this:
// {
//   API_URL_ORIGIN: 'https://cloudfront-staging.tilestream.net',
//   ACCESS_TOKEN: 'pk.eyJ1...'
// }
//
// And in production it will look like this:
// {
//   API_URL_ORIGIN: 'https://api.mapbox.com'
//   ACCESS_TOKEN: 'pk.su33...'
// }
```

### pageShellInit

**Use this function in combination with [`modifyConfig.addDeployEnv`] and [`MaboxPageShell`].**

```js
import pageShellInit from '@mapbox/mapbox-batfish-helpers/browser/page-shell-init';

pageShellInit();
```

When you invoke this function, it does the following for you:

- Disables `MapboxPageShell`'s Sentry error reporting in staging environments.
- Sets `MapboxPageShellProduction = true` in production environments, so the page shell checks the session against production endpoints.

### loadMapboxAssemblyJs

**To use this helper, you must have installed @mapbox/mbx-assembly.**

```js
import loadMapboxAssemblyJs from '@mapbox/mapbox-batfish-helpers/browser/load-mapbox-assembly-js';

loadMapboxAssemblyJs();
```

This will load mbx-assembly's JS in a non-blocking way, by creating an async chunk for Webpack.

**You should also add mbx-assembly's CSS to your Batfish config with the [`modifyConfig.addMapboxAssemblyCss`] helper.**

[`modifyconfig.adddeployenv`]: #modifyconfigadddeployenv

[`modifyconfig.addmapboxassemblycss`]: #modifyconfigaddmapboxassemblycss

[`maboxpageshell`]: https://github.com/mapbox/dotcom-page-shell/blob/master/docs/mapbox-page-shell.md

[`loadmapboxassemblyjs`]: #loadmapboxassemblyjs

[`createenvconfig`]: #createenvconfig
