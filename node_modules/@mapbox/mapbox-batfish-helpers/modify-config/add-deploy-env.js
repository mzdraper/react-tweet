'use strict';

const getDeployEnv = require('./util/get-deploy-env');

module.exports = function addDeployEnv(batfishConfig) {
  let webpack;
  try {
    webpack = require('webpack');
  } catch (error) {
    if (error.code === 'MODULE_NOT_FOUND') {
      throw new Error('You must install webpack before using addDeployEnv');
    } else {
      throw error;
    }
  }

  const deployEnv = getDeployEnv();

  const webpackPlugins = (batfishConfig.webpackPlugins || []).concat(
    new webpack.DefinePlugin({
      'process.env.DEPLOY_ENV': `"${deployEnv}"`
    })
  );

  return Object.assign({}, batfishConfig, { webpackPlugins });
};
